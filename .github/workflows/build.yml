name: Build & Release

on:
  push:
    branches: [ main ]
    paths:
      - 'module.prop'
      - 'post-fs-data.sh'
      - 'service.sh'
      - 'customize.sh'
      - 'uninstall.sh'
      - 'webroot/**'
      - 'META-INF/**'
  workflow_dispatch:
    inputs:
      release:
        description: 'æ˜¯å¦ä¸Šä¼  Release'
        required: true
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

jobs:
  # ==========================================
  # é˜¶æ®µ 1: å˜æ›´æ£€æµ‹
  # ==========================================
  check:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.diff.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect module changes
        id: diff
        run: |
          # æ‰‹åŠ¨è§¦å‘æ—¶å§‹ç»ˆæ„å»º
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger, will build."
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LAST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)

          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found, will build."
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Last release tag: $LAST_TAG"

          MODULE_PATHS=(
            module.prop post-fs-data.sh service.sh
            customize.sh uninstall.sh webroot/ META-INF/
          )

          CHANGED=false
          for p in "${MODULE_PATHS[@]}"; do
            if ! git diff --quiet "$LAST_TAG" HEAD -- "$p" 2>/dev/null; then
              CHANGED=true
              echo "Changed: $p"
            fi
          done

          if [ "$CHANGED" = "true" ]; then
            echo "Module files changed since $LAST_TAG, will build."
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "No module changes since $LAST_TAG, skipping."
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          fi

  # ==========================================
  # é˜¶æ®µ 2: ä»£ç æ£€æŸ¥
  # ==========================================
  lint:
    name: Code Check
    needs: check
    if: needs.check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ShellCheck
        run: |
          echo "=== ShellCheck ==="
          SCRIPTS=(post-fs-data.sh service.sh customize.sh uninstall.sh)
          for script in "${SCRIPTS[@]}"; do
            echo "--- Checking: $script ---"
            if shellcheck -e SC2034,SC2086,SC2169,SC3043,SC3010 -s sh "$script"; then
              echo "PASS: $script"
            else
              echo "WARN: $script (non-blocking)"
            fi
          done

      - name: Validate module.prop
        run: |
          echo "=== Validate module.prop ==="
          REQUIRED_FIELDS=(id name version versionCode author description)
          for field in "${REQUIRED_FIELDS[@]}"; do
            VALUE=$(grep "^${field}=" module.prop | cut -d'=' -f2-)
            if [ -z "$VALUE" ]; then
              echo "FAIL: missing field '${field}'"
              exit 1
            fi
            echo "OK: ${field}=${VALUE}"
          done

          MODULE_ID=$(grep '^id=' module.prop | cut -d'=' -f2)
          if ! echo "$MODULE_ID" | grep -qE '^[a-zA-Z][a-zA-Z0-9._-]+$'; then
            echo "FAIL: invalid module id format '${MODULE_ID}'"
            exit 1
          fi
          echo "OK: id format valid"

          VERSION_CODE=$(grep '^versionCode=' module.prop | cut -d'=' -f2)
          if ! echo "$VERSION_CODE" | grep -qE '^[0-9]+$'; then
            echo "FAIL: versionCode must be integer, got '${VERSION_CODE}'"
            exit 1
          fi
          echo "OK: versionCode is integer"

      - name: Validate module structure
        run: |
          echo "=== Validate module files ==="
          REQUIRED=(
            META-INF/com/google/android/update-binary
            META-INF/com/google/android/updater-script
            module.prop
          )
          for f in "${REQUIRED[@]}"; do
            if [ ! -f "$f" ]; then
              echo "FAIL: missing required file: $f"
              exit 1
            fi
            echo "OK: $f"
          done

          if ! head -1 META-INF/com/google/android/updater-script | grep -q '#MAGISK'; then
            echo "FAIL: updater-script must start with #MAGISK"
            exit 1
          fi
          echo "OK: updater-script format valid"

  # ==========================================
  # é˜¶æ®µ 3: æ„å»º & å‘å¸ƒ
  # ==========================================
  build-release:
    name: Build & Release
    needs: [ check, lint ]
    if: needs.check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---- è‡ªåŠ¨é€’å¢ patch ç‰ˆæœ¬å· ----
      - name: Calculate version
        id: version
        run: |
          # ä» module.prop è¯»å–åŸºç¡€ç‰ˆæœ¬ (å¦‚ v1.1.0)
          BASE_VER=$(grep '^version=' module.prop | cut -d'=' -f2)
          # æå– major.minor (å¦‚ 1.1)
          MAJOR_MINOR=$(echo "$BASE_VER" | sed 's/^v//' | grep -oE '^[0-9]+\.[0-9]+')

          echo "Base version: $BASE_VER"
          echo "Major.Minor: $MAJOR_MINOR"

          # æŸ¥æ‰¾è¯¥ major.minor ä¸‹å·²æœ‰çš„æœ€å¤§ patch å·
          MAX_PATCH=-1
          for tag in $(git tag -l "v${MAJOR_MINOR}.*" 2>/dev/null); do
            PATCH=$(echo "$tag" | sed "s/^v${MAJOR_MINOR}\.//" | grep -oE '^[0-9]+')
            if [ -n "$PATCH" ] && [ "$PATCH" -gt "$MAX_PATCH" ]; then
              MAX_PATCH=$PATCH
            fi
          done

          # æ–° patch = max + 1ï¼Œé¦–æ¬¡åˆ™ä¸º 0
          if [ "$MAX_PATCH" -lt 0 ]; then
            NEW_PATCH=0
          else
            NEW_PATCH=$((MAX_PATCH + 1))
          fi

          NEW_VER="v${MAJOR_MINOR}.${NEW_PATCH}"
          # versionCode ç›´æ¥ç”¨ patch ç´¯è®¡å€¼
          BASE_CODE=$(grep '^versionCode=' module.prop | cut -d'=' -f2)
          NEW_CODE=$((BASE_CODE + NEW_PATCH))

          echo "new_ver=${NEW_VER}" >> "$GITHUB_OUTPUT"
          echo "new_code=${NEW_CODE}" >> "$GITHUB_OUTPUT"
          echo "major_minor=${MAJOR_MINOR}" >> "$GITHUB_OUTPUT"

          echo "New version: $NEW_VER (code: $NEW_CODE)"

      # ---- åˆ¤æ–­æ˜¯å¦å‘å¸ƒ Release ----
      - name: Determine release mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.release }}" = "yes" ]; then
              echo "is_release=true" >> "$GITHUB_OUTPUT"
              echo "is_ci=false" >> "$GITHUB_OUTPUT"
              echo "Mode: Release"
            else
              echo "is_release=false" >> "$GITHUB_OUTPUT"
              echo "is_ci=true" >> "$GITHUB_OUTPUT"
              echo "Mode: CI Build (no release)"
            fi
          else
            # push äº‹ä»¶ â†’ CI æ„å»ºï¼Œä¸å‘å¸ƒ Release
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "is_ci=true" >> "$GITHUB_OUTPUT"
            echo "Mode: CI Build (push trigger)"
          fi

      # ---- è·å–æ¨¡å—ä¿¡æ¯ ----
      - name: Get module info
        id: info
        run: |
          MODULE_ID=$(grep '^id=' module.prop | cut -d'=' -f2)
          MODULE_NAME=$(grep '^name=' module.prop | cut -d'=' -f2-)
          MODULE_DESC=$(grep '^description=' module.prop | cut -d'=' -f2-)
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)
          NEW_VER="${{ steps.version.outputs.new_ver }}"
          FILENAME="${MODULE_ID}-${NEW_VER}-${SHORT_SHA}"
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')

          echo "module_id=${MODULE_ID}" >> "$GITHUB_OUTPUT"
          echo "module_name=${MODULE_NAME}" >> "$GITHUB_OUTPUT"
          echo "module_desc=${MODULE_DESC}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "full_sha=${FULL_SHA}" >> "$GITHUB_OUTPUT"
          echo "filename=${FILENAME}" >> "$GITHUB_OUTPUT"
          echo "build_date=${BUILD_DATE}" >> "$GITHUB_OUTPUT"

          echo "Output filename: ${FILENAME}.zip"

      # ---- å†™å…¥ç‰ˆæœ¬å·åˆ° module.prop (CI æ„å»ºåŠ æ ‡è¯†) ----
      - name: Patch module.prop
        run: |
          NEW_VER="${{ steps.version.outputs.new_ver }}"
          NEW_CODE="${{ steps.version.outputs.new_code }}"
          IS_CI="${{ steps.mode.outputs.is_ci }}"

          if [ "$IS_CI" = "true" ]; then
            # CI æ„å»º: ç‰ˆæœ¬å·åŠ  -ci åç¼€ï¼Œæè¿°åŠ  [CI Build] æ ‡è¯†
            sed -i "s/^version=.*/version=${NEW_VER}-ci/" module.prop
            sed -i "s/^versionCode=.*/versionCode=${NEW_CODE}/" module.prop
            sed -i "s/^description=.*/&\n# [CI Build] æ­¤ç‰ˆæœ¬ç”± CI è‡ªåŠ¨æ„å»ºï¼Œéæ­£å¼å‘å¸ƒç‰ˆæœ¬/" module.prop
            echo "Patched module.prop with CI identifier"
          else
            # Release æ„å»º: ä»…æ›´æ–°ç‰ˆæœ¬å·
            sed -i "s/^version=.*/version=${NEW_VER}/" module.prop
            sed -i "s/^versionCode=.*/versionCode=${NEW_CODE}/" module.prop
            echo "Patched module.prop for release"
          fi

          echo "--- module.prop ---"
          cat module.prop

      # ---- åŒæ­¥ç‰ˆæœ¬å·åˆ° WebUI å’Œ customize.sh ----
      - name: Patch version in all files
        run: |
          NEW_VER="${{ steps.version.outputs.new_ver }}"
          IS_CI="${{ steps.mode.outputs.is_ci }}"

          if [ "$IS_CI" = "true" ]; then
            DISPLAY_VER="${NEW_VER}-ci"
          else
            DISPLAY_VER="${NEW_VER}"
          fi

          # customize.sh å®‰è£…ç•Œé¢ç‰ˆæœ¬å·
          sed -i "s/â•‘  ç‰ˆæœ¬: v[0-9.]*/â•‘  ç‰ˆæœ¬: ${DISPLAY_VER}/" customize.sh

          # WebUI Hero badge
          sed -i "s/Device Spoofer v[0-9.]*/Device Spoofer ${DISPLAY_VER}/" webroot/index.html

          # WebUI footer
          sed -i "s/Device Spoofer v[0-9.]*/Device Spoofer ${DISPLAY_VER}/" webroot/index.html

          echo "All files patched to ${DISPLAY_VER}"

      # ---- ç”Ÿæˆ changelog ----
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)

          if [ -n "$LAST_TAG" ]; then
            LOG=$(git log "${LAST_TAG}..HEAD" --pretty=format:"- %s (\`%h\`)" --no-merges -- \
              module.prop post-fs-data.sh service.sh \
              customize.sh uninstall.sh 'webroot/*' 'META-INF/*')
          else
            LOG=$(git log --pretty=format:"- %s (\`%h\`)" --no-merges)
          fi

          if [ -z "$LOG" ]; then
            LOG="- Initial release"
          fi

          {
            echo "log<<CHANGELOG_EOF"
            echo "$LOG"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      # ---- æ‰“åŒ… ----
      - name: Build flashable ZIP
        id: build
        run: |
          MODULE_FILES=(
            META-INF/com/google/android/update-binary
            META-INF/com/google/android/updater-script
            module.prop
            post-fs-data.sh
            service.sh
            customize.sh
            uninstall.sh
            webroot/index.html
          )

          OUTNAME="${{ steps.info.outputs.filename }}.zip"
          zip -9 "$OUTNAME" "${MODULE_FILES[@]}"

          SHA256=$(sha256sum "$OUTNAME" | cut -d' ' -f1)
          SIZE=$(stat -c%s "$OUTNAME")
          SIZE_KB=$(echo "scale=1; $SIZE / 1024" | bc)

          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "size=${SIZE_KB} KB" >> "$GITHUB_OUTPUT"

          echo "Built: $OUTNAME (${SIZE_KB} KB)"
          echo "SHA256: $SHA256"
          unzip -t "$OUTNAME"

      # ---- ä¸Šä¼  Artifact (å§‹ç»ˆä¸Šä¼ ) ----
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.info.outputs.filename }}
          path: ${{ steps.info.outputs.filename }}.zip
          compression-level: 0

      # ---- åˆ›å»º Release (ä»… release æ¨¡å¼) ----
      - name: Create Release
        if: steps.mode.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_ver }}
          name: "ğŸš€ ${{ steps.info.outputs.module_name }} ${{ steps.version.outputs.new_ver }}"
          body: |
            ## ğŸ“± ${{ steps.info.outputs.module_name }}

            > ${{ steps.info.outputs.module_desc }}

            ---

            ### ğŸ¯ ä¼ªè£…ç›®æ ‡

            | å±æ€§ | å€¼ |
            |:---|:---|
            | è¥é”€åç§° | **Xiaomi 17 Pro Max** |
            | å‹å·å·ç  | `2509FPN0BC` |
            | è®¾å¤‡ä»£å· | `popsicle` |
            | å“ç‰Œ | Xiaomi |
            | HyperOS 3 ç‰ˆæœ¬å· | `OS3.0.45.0.WPBCNXM` |

            ### âœ… å…¼å®¹æ€§

            | Root æ–¹æ¡ˆ | æ”¯æŒ |
            |:---|:---:|
            | Magisk (v20.4+) | âœ… |
            | KernelSU | âœ… |
            | APatch | âœ… |

            | ç³»ç»Ÿç‰ˆæœ¬ | æ”¯æŒ |
            |:---|:---:|
            | MIUI 12 / 13 / 14 | âœ… |
            | HyperOS 1.0 / 2.0 | âœ… |
            | HyperOS 3.0 | âœ… (è‡ªåŠ¨ä¿®æ”¹ç‰ˆæœ¬å·) |

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            ${{ steps.changelog.outputs.log }}

            ### ğŸ“¦ æ„å»ºä¿¡æ¯

            | é¡¹ç›® | å€¼ |
            |:---|:---|
            | æ–‡ä»¶å | `${{ steps.info.outputs.filename }}.zip` |
            | ç‰ˆæœ¬ | `${{ steps.version.outputs.new_ver }}` |
            | å¤§å° | ${{ steps.build.outputs.size }} |
            | SHA-256 | `${{ steps.build.outputs.sha256 }}` |
            | Commit | [`${{ steps.info.outputs.short_sha }}`](https://github.com/${{ github.repository }}/commit/${{ steps.info.outputs.full_sha }}) |
            | æ„å»ºæ—¶é—´ | ${{ steps.info.outputs.build_date }} |

            ### ğŸ“¥ å®‰è£…æ–¹æ³•

            1. ä¸‹è½½ä¸‹æ–¹ ZIP æ–‡ä»¶
            2. æ‰“å¼€ **Magisk / KernelSU / APatch** ç®¡ç†å™¨
            3. é€‰æ‹©ã€Œä»æœ¬åœ°å®‰è£…ã€â†’ é€‰ä¸­ ZIP æ–‡ä»¶
            4. ç­‰å¾…å®‰è£…å®Œæˆå **é‡å¯è®¾å¤‡**

            > âš ï¸ å¦‚éœ€æ¢å¤åŸå§‹è®¾å¤‡ä¿¡æ¯ï¼Œåœ¨ç®¡ç†å™¨ä¸­å¸è½½æœ¬æ¨¡å—åé‡å¯å³å¯ã€‚

            ---
            *Built with GitHub Actions Â· Powered by Sober UI*
          files: ${{ steps.info.outputs.filename }}.zip
          make_latest: true
