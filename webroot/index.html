<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeviceSpoofX</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tdesign-mobile-vue@1.13.0/dist/tdesign.min.css">
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --app-bg: #f5f5f5;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            --text-primary: #1a1a2e;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: rgba(0, 0, 0, 0.05);
            --hero-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --accent-color: #6366f1;
            --accent-light: rgba(99, 102, 241, 0.1);
            --section-title-color: #6366f1;
            --mono-font: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'SF Mono', monospace;
        }

        [theme-mode="dark"] {
            --app-bg: #0f0f1a;
            --card-bg: #1a1a2e;
            --card-shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --border-color: rgba(255, 255, 255, 0.06);
            --accent-light: rgba(99, 102, 241, 0.15);
            --section-title-color: #818cf8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, 'HarmonyOS Sans', 'Mi Sans', system-ui, sans-serif;
            background: var(--app-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #app { min-height: 100vh; }

        .scroll-area {
            padding: 0 16px 32px;
            padding-bottom: calc(32px + var(--safe-bottom));
        }

        /* ---- Hero 卡片 ---- */
        .hero {
            position: relative;
            padding: 32px 24px 28px;
            margin: 16px 0 20px;
            border-radius: 24px;
            overflow: hidden;
            background: var(--hero-gradient);
            color: #fff;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        .hero::before {
            content: '';
            position: absolute;
            top: -60%; right: -30%;
            width: 300px; height: 300px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            animation: heroFloat 6s ease-in-out infinite;
        }
        .hero::after {
            content: '';
            position: absolute;
            bottom: -40%; left: -15%;
            width: 240px; height: 240px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            animation: heroFloat 8s ease-in-out infinite reverse;
        }
        @keyframes heroFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(10px, -15px); }
        }
        .hero-content { position: relative; z-index: 1; }
        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 14px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            margin-bottom: 18px;
        }
        .hero-title {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1.2;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .hero-subtitle {
            margin-top: 8px;
            font-size: 0.85rem;
            opacity: 0.85;
            line-height: 1.6;
            font-weight: 400;
        }
        .hero-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 20px;
        }
        .hero-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            font-size: 0.78rem;
            font-weight: 500;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.active {
            background: #34d399;
            box-shadow: 0 0 8px rgba(52, 211, 153, 0.6);
        }
        .status-dot.inactive {
            background: #f87171;
            box-shadow: 0 0 8px rgba(248, 113, 113, 0.6);
        }

        /* ---- 区块标题 ---- */
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 4px;
            margin: 28px 0 12px;
        }
        .section-icon {
            width: 20px; height: 20px;
            color: var(--section-title-color);
        }
        .section-title {
            font-size: 0.82rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--section-title-color);
        }

        /* ---- 通用卡片容器 ---- */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 12px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .card:active {
            transform: scale(0.985);
        }
        .card-inner { padding: 4px 0; }

        /* ---- 信息行 ---- */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 13px 20px;
        }
        .info-row:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }
        .info-label {
            font-size: 0.84rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-right: 16px;
        }
        .info-value {
            font-size: 0.84rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: right;
            word-break: break-all;
            font-family: var(--mono-font);
        }
        .info-hint {
            display: block;
            font-size: 0.7rem;
            font-weight: 400;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* ---- 属性分组折叠 ---- */
        .prop-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 12px;
        }
        .prop-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.15s ease;
        }
        .prop-header:active {
            background: var(--accent-light);
        }
        .prop-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .prop-group-icon {
            width: 32px; height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-light);
            color: var(--accent-color);
            flex-shrink: 0;
        }
        .prop-group-icon svg {
            width: 18px; height: 18px;
        }
        .prop-group-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .prop-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prop-count {
            font-size: 0.72rem;
            font-weight: 600;
            padding: 2px 10px;
            border-radius: 10px;
            background: var(--accent-light);
            color: var(--accent-color);
        }
        .prop-arrow {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-tertiary);
            width: 20px; height: 20px;
        }
        .prop-arrow.open { transform: rotate(180deg); }
        .prop-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .prop-body.expanded { max-height: 3000px; }
        .prop-body-inner { padding: 0 20px 16px; }
        .prop-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px 0;
        }
        .prop-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }
        .prop-key {
            font-size: 0.74rem;
            color: var(--accent-color);
            font-family: var(--mono-font);
            word-break: break-all;
            opacity: 0.85;
        }
        .prop-val {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--mono-font);
            word-break: break-all;
        }

        /* ---- 刷新按钮 ---- */
        .refresh-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 16px;
            background: var(--card-bg);
            box-shadow: var(--card-shadow);
            color: var(--accent-color);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.15s ease, background 0.15s ease;
        }
        .refresh-btn:active {
            transform: scale(0.97);
            background: var(--accent-light);
        }
        .refresh-btn svg {
            width: 20px; height: 20px;
            transition: transform 0.4s ease;
        }
        .refresh-btn.spinning svg {
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ---- Footer ---- */
        .footer {
            text-align: center;
            padding: 24px 0 12px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            line-height: 1.8;
        }
        .footer-brand {
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* ---- 加载遮罩 ---- */
        .loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            background: var(--app-bg);
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loading-overlay.hide {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .loading-text {
            font-size: 0.88rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ---- 入场动画 ---- */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .anim {
            opacity: 0;
            animation: fadeUp 0.55s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        /* ---- Navbar 样式覆盖 ---- */
        .t-navbar {
            background: var(--card-bg) !important;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04) !important;
        }
        .t-navbar__title {
            font-weight: 700 !important;
            letter-spacing: -0.01em !important;
        }

        /* ---- 配置切换 ---- */
        .profile-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 10px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            border: 2px solid transparent;
        }
        .profile-item:active { transform: scale(0.985); }
        .profile-item.active {
            border-color: var(--accent-color);
            background: var(--accent-light);
        }
        .profile-item-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .profile-item-name {
            font-size: 0.92rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .profile-item-detail {
            font-size: 0.74rem;
            color: var(--text-secondary);
            font-family: var(--mono-font);
        }
        .profile-check {
            width: 22px; height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .profile-check.checked {
            border-color: var(--accent-color);
            background: var(--accent-color);
        }
        .profile-check svg {
            width: 14px; height: 14px;
            color: #fff;
        }
        .reboot-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            border-radius: 16px;
            color: #fff;
            margin-bottom: 10px;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }
        .reboot-banner-text {
            font-size: 0.84rem;
            font-weight: 500;
            line-height: 1.4;
        }
        .reboot-btn {
            flex-shrink: 0;
            padding: 8px 20px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 12px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #fff;
            font-size: 0.84rem;
            font-weight: 700;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.15s ease, transform 0.15s ease;
        }
        .reboot-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
<div id="app">
    <!-- 加载遮罩 -->
    <div class="loading-overlay" :class="{ hide: !loading }">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在读取设备信息...</div>
    </div>

    <!-- 顶栏 -->
    <t-navbar title="DeviceSpoofX" :left-arrow="true" :fixed="true" :placeholder="true"
              @left-click="goBack"></t-navbar>

    <div class="scroll-area">
        <!-- Hero -->
        <div class="hero anim" style="animation-delay:.05s">
            <div class="hero-content">
                <div class="hero-badge">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
                    Device Spoofer v2.0.0
                </div>
                <div class="hero-title">{{ profile.marketname }}</div>
                <div class="hero-subtitle">适配 MIUI 12 ~ HyperOS 3 · Magisk / KernelSU / APatch</div>
                <div class="hero-chips">
                    <div class="hero-chip">
                        <span class="status-dot" :class="moduleActive ? 'active' : 'inactive'"></span>
                        <span>{{ moduleActive ? '模块已激活' : '模块未激活' }}</span>
                    </div>
                    <div class="hero-chip">
                        <span>{{ rootSolution }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配置切换 -->
        <div class="section-header anim" style="animation-delay:.10s">
            <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg>
            <span class="section-title">伪装机型</span>
        </div>
        <div class="anim" style="animation-delay:.12s">
            <div class="reboot-banner" v-if="needReboot">
                <span class="reboot-banner-text">配置已切换，重启后生效</span>
                <button class="reboot-btn" @click="rebootDevice">立即重启</button>
            </div>
            <div class="profile-item" v-for="p in profileList" :key="p.key"
                 :class="{ active: p.key === activeProfileKey }"
                 @click="switchProfile(p.key)">
                <div class="profile-item-left">
                    <span class="profile-item-name">{{ p.name }}</span>
                    <span class="profile-item-detail">{{ p.model }} / {{ p.device }}</span>
                </div>
                <div class="profile-check" :class="{ checked: p.key === activeProfileKey }">
                    <svg v-if="p.key === activeProfileKey" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </div>
            </div>
        </div>

        <!-- 刷新按钮 -->
        <button class="refresh-btn anim" :class="{ spinning: refreshing }"
                style="animation-delay:.12s" @click="onRefresh">
            <svg viewBox="0 -960 960 960" fill="currentColor"><path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/></svg>
            刷新状态
        </button>

        <!-- 伪装目标 -->
        <div class="section-header anim" style="animation-delay:.18s">
            <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
            <span class="section-title">伪装目标</span>
        </div>
        <div class="card anim" style="animation-delay:.22s">
            <div class="card-inner">
                <div class="info-row" v-for="item in targetInfo" :key="item.label">
                    <span class="info-label">{{ item.label }}</span>
                    <span class="info-value" v-html="item.value"></span>
                </div>
            </div>
        </div>

        <!-- 当前系统属性 -->
        <div class="section-header anim" style="animation-delay:.28s">
            <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            <span class="section-title">当前系统属性</span>
        </div>
        <div class="card anim" style="animation-delay:.32s">
            <div class="card-inner">
                <div class="info-row" v-for="item in currentInfo" :key="item.label">
                    <span class="info-label">{{ item.label }}</span>
                    <span class="info-value" :style="item.style || {}">{{ item.value }}</span>
                </div>
            </div>
        </div>

        <!-- 已修改属性 -->
        <div class="section-header anim" style="animation-delay:.38s">
            <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            <span class="section-title">已修改属性</span>
        </div>
        <div class="anim" style="animation-delay:.42s">
            <div class="prop-card" v-for="(group, gi) in PROP_GROUPS" :key="gi">
                <div class="prop-header" @click="toggleGroup(gi)">
                    <div class="prop-header-left">
                        <div class="prop-group-icon" v-html="groupIcons[gi]"></div>
                        <span class="prop-group-title">{{ group.title }}</span>
                    </div>
                    <div class="prop-header-right">
                        <span class="prop-count">{{ countProps(group) }} 项</span>
                        <svg class="prop-arrow" :class="{ open: expandedGroups[gi] }" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
                    </div>
                </div>
                <div class="prop-body" :class="{ expanded: expandedGroups[gi] }">
                    <div class="prop-body-inner">
                        <div class="prop-item" v-for="key in group.props" :key="key">
                            <span class="prop-key">{{ key }}</span>
                            <span class="prop-val">{{ propValues[key] || '(empty)' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer anim" style="animation-delay:.52s">
            <span class="footer-brand">DeviceSpoofX</span> v2.0.0<br>
            Profile: {{ profile.marketname }}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tdesign-mobile-vue@1.13.0/dist/tdesign.min.js"></script>
<script>
// ============================================================
//  暗黑模式自动检测
// ============================================================
(function initTheme() {
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    function apply(dark) {
        if (dark) {
            document.documentElement.setAttribute('theme-mode', 'dark');
        } else {
            document.documentElement.removeAttribute('theme-mode');
        }
    }
    apply(mq.matches);
    mq.addEventListener('change', e => apply(e.matches));
})();

// ============================================================
//  KernelSU / APatch / Magisk JavaScript Bridge
// ============================================================
let _cbId = 0;
function exec(cmd, opts = {}) {
    return new Promise(resolve => {
        const cb = `__cb_${Date.now()}_${_cbId++}`;
        window[cb] = (errno, stdout, stderr) => {
            resolve({ errno, stdout: stdout || '', stderr: stderr || '' });
            delete window[cb];
        };
        try {
            if (typeof ksu !== 'undefined') {
                ksu.exec(cmd, JSON.stringify(opts), cb);
            } else {
                resolve({ errno: 1, stdout: '', stderr: 'ksu not available (browser debug mode)' });
            }
        } catch (e) {
            resolve({ errno: 1, stdout: '', stderr: e.message });
        }
    });
}

function showToast(msg) {
    if (typeof ksu !== 'undefined') { ksu.toast(msg); return; }
    if (typeof TDesign !== 'undefined' && TDesign.Toast) {
        TDesign.Toast({ message: msg, duration: 2000, placement: 'bottom' });
    }
}

// ============================================================
//  读取系统属性
// ============================================================
async function getProp(key) {
    const { errno, stdout } = await exec(`getprop ${key}`);
    return errno === 0 ? stdout.trim() : '';
}

async function getProps(keys) {
    const script = keys.map(k => `echo "@@${k}@@=$(getprop ${k})"`).join(';');
    const { stdout } = await exec(`sh -c '${script}'`);
    const result = {};
    keys.forEach(k => {
        const m = stdout.match(new RegExp(`@@${k.replace(/\./g, '\\.')}@@=(.*)`));
        result[k] = m ? m[1].trim() : '';
    });
    return result;
}

// ============================================================
//  读取设备配置文件
// ============================================================
const MODULE_ID = 'DeviceSpoofX';
const MODULE_DIR = `/data/adb/modules/${MODULE_ID}`;

const DEFAULT_PROFILE = {
    marketname: 'Xiaomi 17 Pro Max',
    model: '2509FPN0BC',
    device: 'popsicle',
    brand: 'Xiaomi',
    manufacturer: 'Xiaomi',
    displayId: 'OS3.0.45.0.WPBCNXM',
    hostname: 'Xiaomi-17-Pro-Max',
    ram: '17179869184',
};

function parseProfile(text) {
    const p = {};
    const map = {
        PROFILE_NAME: 'marketname',
        TARGET_MODEL: 'model',
        TARGET_DEVICE: 'device',
        TARGET_NAME: 'name',
        TARGET_BRAND: 'brand',
        TARGET_MANUFACTURER: 'manufacturer',
        TARGET_MARKETNAME: 'marketname',
        TARGET_DISPLAY_ID: 'displayId',
        TARGET_HOSTNAME: 'hostname',
        TARGET_RAM: 'ram',
    };
    text.split('\n').forEach(line => {
        line = line.trim();
        if (!line || line.startsWith('#')) return;
        const eq = line.indexOf('=');
        if (eq < 0) return;
        const key = line.substring(0, eq);
        const val = line.substring(eq + 1).replace(/^["']|["']$/g, '');
        if (map[key]) p[map[key]] = val;
    });
    return p;
}

async function loadProfile() {
    const { stdout: profileKey } = await exec(`cat ${MODULE_DIR}/current_profile 2>/dev/null`);
    const key = profileKey.trim();
    if (!key) return { key: 'xiaomi-17-pro-max', ...DEFAULT_PROFILE };
    const { errno, stdout } = await exec(`cat ${MODULE_DIR}/profiles/${key}.conf 2>/dev/null`);
    if (errno !== 0 || !stdout.trim()) return { key, ...DEFAULT_PROFILE };
    const parsed = parseProfile(stdout);
    return Object.keys(parsed).length > 0 ? { key, ...DEFAULT_PROFILE, ...parsed } : { key, ...DEFAULT_PROFILE };
}

async function loadAllProfiles() {
    const { stdout } = await exec(`ls ${MODULE_DIR}/profiles/*.conf 2>/dev/null`);
    const files = stdout.trim().split('\n').filter(f => f.trim());
    const list = [];
    for (const f of files) {
        const key = f.replace(/^.*\//, '').replace(/\.conf$/, '');
        const { stdout: content } = await exec(`cat "${f}" 2>/dev/null`);
        const parsed = parseProfile(content);
        list.push({
            key,
            name: parsed.marketname || key,
            model: parsed.model || '--',
            device: parsed.device || '--',
        });
    }
    return list;
}

// ============================================================
//  属性分组定义
// ============================================================
const PROP_GROUPS = [
    {
        title: '设备型号',
        props: [
            'ro.product.model', 'ro.product.system.model',
            'ro.product.vendor.model', 'ro.product.odm.model',
            'ro.product.product.model', 'ro.product.system_ext.model',
        ]
    },
    {
        title: '设备代号',
        props: [
            'ro.product.device', 'ro.product.system.device',
            'ro.product.vendor.device', 'ro.product.odm.device',
            'ro.build.product',
        ]
    },
    {
        title: '产品名称',
        props: [
            'ro.product.name', 'ro.product.system.name',
            'ro.product.vendor.name', 'ro.product.odm.name',
        ]
    },
    {
        title: '品牌与制造商',
        props: [
            'ro.product.brand', 'ro.product.system.brand',
            'ro.product.vendor.brand', 'ro.product.manufacturer',
        ]
    },
    {
        title: '营销名称',
        props: [
            'ro.product.marketname', 'ro.product.odm.marketname',
            'ro.product.vendor.marketname', 'persist.sys.device_name',
        ]
    },
    {
        title: '系统版本号',
        props: [
            'ro.build.display.id', 'ro.mi.os.version.incremental',
            'ro.mi.os.version.name', 'ro.mi.os.version.code',
            'ro.build.version.incremental', 'ro.system.build.display.id',
            'ro.vendor.build.display.id', 'ro.odm.build.display.id',
            'ro.miui.ui.version.name',
        ]
    },
];

// ============================================================
//  分组图标 SVG
// ============================================================
const GROUP_ICONS = [
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg>',
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 9V7h-2V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v2H2v2h2v2H2v2h2v2H2v2h2v2c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2zm-4 10H6V5h12v14z"/></svg>',
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg>',
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>',
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg>',
    '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79 2.73 2.71 7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58 3.51-3.47 9.14-3.47 12.65 0L21 3v7.12z"/></svg>',
];

// ============================================================
//  检测 Root 方案
// ============================================================
async function detectRoot() {
    let r = await exec('which ksud');
    if (r.errno === 0 && r.stdout.trim()) {
        const ver = await exec('ksud --version');
        return 'KernelSU ' + (ver.stdout.trim().split('\n')[0] || '');
    }
    r = await exec('which apd');
    if (r.errno === 0 && r.stdout.trim()) return 'APatch';
    r = await exec('magisk -c');
    if (r.errno === 0 && r.stdout.trim()) return 'Magisk ' + r.stdout.trim();
    return 'Root: Unknown';
}

// ============================================================
//  检测模块状态
// ============================================================

async function checkModuleStatus() {
    const { errno } = await exec(`[ -d "${MODULE_DIR}" ] && [ ! -f "${MODULE_DIR}/disable" ]`);
    return errno === 0;
}

// ============================================================
//  Vue 3 App
// ============================================================
const { createApp, ref, reactive, computed, onMounted } = Vue;

const app = createApp({
    setup() {
        const profile = reactive({ ...DEFAULT_PROFILE });
        const loading = ref(true);
        const refreshing = ref(false);
        const moduleActive = ref(false);
        const rootSolution = ref('Root: --');
        const propValues = reactive({});
        const expandedGroups = reactive({});
        const profileList = ref([]);
        const activeProfileKey = ref('');
        const needReboot = ref(false);

        // 分组图标
        const groupIcons = GROUP_ICONS;

        // 伪装目标信息（从 profile 动态生成）
        const targetInfo = computed(() => [
            { label: '营销名称', value: profile.marketname },
            { label: '型号号码', value: profile.model },
            { label: '设备代号', value: profile.device },
            { label: '品牌', value: profile.brand },
            { label: '版本号', value: `${profile.displayId}<span class="info-hint">仅 HyperOS 3 自动生效</span>` },
        ]);

        // 当前系统属性
        const currentInfo = computed(() => {
            const miuiVer = propValues['ro.miui.ui.version.name'] || '';
            const displayId = propValues['ro.build.display.id'] || '';
            const isHyperOS3 = miuiVer.startsWith('V170') || displayId.startsWith('OS3');
            return [
                { label: '营销名称', value: propValues['ro.product.marketname'] || '--' },
                { label: '型号', value: propValues['ro.product.model'] || '--' },
                { label: '设备代号', value: propValues['ro.product.device'] || '--' },
                { label: '品牌', value: propValues['ro.product.brand'] || '--' },
                { label: 'Android 版本', value: propValues['ro.build.version.release'] || '--' },
                { label: '系统版本', value: displayId || miuiVer || '--' },
                {
                    label: 'HyperOS 3',
                    value: isHyperOS3 ? '已检测 · 版本号已修改' : '未检测到 · 版本号不修改',
                    style: { color: isHyperOS3 ? 'var(--accent-color)' : 'var(--text-secondary)' },
                },
            ];
        });

        // 计算属性数量
        function countProps(group) {
            return group.props.filter(p => propValues[p] !== undefined).length || group.props.length;
        }

        // 折叠切换
        function toggleGroup(index) {
            expandedGroups[index] = !expandedGroups[index];
        }

        // 返回
        function goBack() {
            if (typeof ksu !== 'undefined') history.back();
        }

        // 主加载逻辑
        async function loadAll() {
            const allKeys = PROP_GROUPS.flatMap(g => g.props);
            const infoKeys = [
                'ro.product.marketname', 'ro.product.model', 'ro.product.device',
                'ro.product.brand', 'ro.build.version.release', 'ro.miui.ui.version.name',
                'ro.build.display.id',
            ];
            const mergedKeys = [...new Set([...allKeys, ...infoKeys])];

            const [vals, root, active, profileData, profiles] = await Promise.all([
                getProps(mergedKeys),
                detectRoot(),
                checkModuleStatus(),
                loadProfile(),
                loadAllProfiles(),
            ]);

            Object.assign(profile, profileData);
            activeProfileKey.value = profileData.key || 'xiaomi-17-pro-max';
            profileList.value = profiles;
            Object.assign(propValues, vals);
            rootSolution.value = root;
            moduleActive.value = active;
        }

        // 切换配置
        async function switchProfile(key) {
            if (key === activeProfileKey.value) return;
            await exec(`echo "${key}" > ${MODULE_DIR}/current_profile`);
            activeProfileKey.value = key;
            // 重新加载当前 profile 数据来更新 UI
            const profileData = await loadProfile();
            Object.assign(profile, profileData);
            needReboot.value = true;
            showToast('配置已切换，重启后生效');
        }

        // 重启设备
        async function rebootDevice() {
            showToast('正在重启...');
            await exec('svc power reboot');
        }

        // 刷新
        async function onRefresh() {
            refreshing.value = true;
            await loadAll();
            refreshing.value = false;
            showToast('已刷新');
        }

        // 初始化
        onMounted(async () => {
            await loadAll();
            loading.value = false;
        });

        return {
            profile, loading, refreshing, moduleActive, rootSolution,
            propValues, expandedGroups, groupIcons, targetInfo, currentInfo,
            profileList, activeProfileKey, needReboot,
            PROP_GROUPS, countProps, toggleGroup, goBack, onRefresh,
            switchProfile, rebootDevice,
        };
    }
});

app.use(TDesign);
app.mount('#app');
</script>
</body>
</html>
